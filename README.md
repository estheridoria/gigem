README
================
2025-08-19

[Github Page](https://github.com/estheridoria/gigem)

[Li Lab Page](https://wanheli2022.wixsite.com/wanheli)

Created by Esther Doria, Wanhe Li, & Daniel Nguyen August 2024

Copyright (C) year-range Full Names

Contact: <estheridoria@gmail.com>

## 0. Installation and Example Data

### 0.1 Install gigem

Install and attach devtools which can install gigem

``` main
install.packages("devtools")
library(devtools)
install_github('Wanhelilab/gigem')
library(gigem)
```

### 0.2 Download the template files

Run the code below to copy the template files into your working
directory.

Alternatively, manually copy and paste the code from section 5 into two
separate files.

``` main
# Download "HitRun.R"
auth_url <- paste0("https://raw.githubusercontent.com/estheridoria/gigem/main/HitRun.R")
download.file(auth_url, destfile = "HitRun.R", method = "libcurl")

# Download "Main1.R"
auth_url <- paste0("https://raw.githubusercontent.com/estheridoria/gigem.Example/main/Main.R")
download.file(auth_url, destfile = "Main.R", method = "libcurl")
```

### 0.3 Download example analysis

Download the example data into your working directory under
“ExampleAnalysis” (optional).

``` main
dest_dir <- paste0(getwd(),"/ExampleAnalysis")
system(paste("git clone", "https://github.com/WanheLiLab/gigem.Example.git", dest_dir))
```

## 1. Experimental Parameters: Creating a ‘Main.R’ File

Create a folder which will be your parent directory.

Create folders inside that parent directory equal to the number of
experiments (Batches) you ran. These will be your sub-directory folders.
Each sub-directory folder should be named ‘Batch’ followed by any
combination of letters, numbers and/or underscores, effectively labeling
the experiment you ran.

Create an R script within each sub-directory, naming it ‘Main’ followed
by the same experimental label used for the sub-directory folder.

Add the ‘monitor.txt’ files corresponding to each experimental batch
into their respective sub-directory folders.

<figure>
<img src="images/Directories.jpg" alt="Directory Layout" />
<figcaption aria-hidden="true">Directory Layout</figcaption>
</figure>

### 1.1 Monitor Specifications

Within each Main file, name the `Title` the same as the sub-directory
folder containing it.

``` main
# Title for data analysis.
Title="Batch..."
```

The variable `file` refers to the particular files generated by the
Drosophila Activity Monitor (DAM) System (these should be full of 1s and
0s). Add the names of the monitor files generated in *your* experiment
to replace the example ones below.

``` main
# Create a data table 'info' to store details of the monitoring setup
info <- data.table::data.table(
  
  # Filename associated with each monitor data
  file = rep(c("Monitor22.txt", "Monitor7.txt",
               "Monitor14.txt", "Monitor3.txt",
               "Monitor15.txt", "Monitor39.txt",
               "Monitor53.txt", "Monitor27.txt",
               "Monitor52.txt", "Monitor17.txt",
               "Monitor21.txt", "Monitor50.txt"), each = 32),
```

Throughout this file, both `region_id` and the term `each = 32`
signifies the number of flies each DAM monitor holds. If your monitor
holds more or fewer flies than 32, you will need to change this number
for each of the experimental factors.

``` main
  # Unique numerical identifier for each arena within the DAM
  region_id = 1:32,
```

### 1.2 `OK` or `notOK` Status

The standard `status` of each fly is “OK”. See section 1.6 to manually
change the `status` of certain flies and, consequently, omit them from
analysis

``` main
  # Status of the data (e.g., "OK")
  status = "OK",
```

### 1.3 Start/Stop Points

The `start_datetime` should be the first light-on time-point after the
flies have been loaded into the monitor(s). The `stop_datetime` is the
last light-on time-point (plus an  hour) before removing them from
the monitors. Typically, this will be between two to four Zeitgeber
cycles (48-96 hours for a typical 24-hour cycle) after the
`start_datetime` time-point. Please ensure that the time `stop_datetime`
is an hour past the light-on time point; this will ensure none of
the flies are mistakenly considered dead during a sleep bout at the end of the last day.

``` main
  # Start date and time of the monitoring period
  start_datetime = "2019-08-17 10:00:00",
  
  # Stop date and time of the monitoring period
  stop_datetime = "2019-08-19 11:00:00",
```

### 1.4 Experimental Factors: Organism Specifications

Match the `sex` and `genotype` of the flies to their respective monitors
as listed above. For example,

`file` = `Monitor22.txt` correlates to `Sex` = `M` (for male), `Genotype` = `SIP-L2-2`, `Temperature` = `21.5C`, `Treatment` =
`Iso_2D`, `Environment` = `"Vial"`, `Light` = `"12:12"`

Therefore, the number of entries in each variable should be the same
(excepting the ones where each monitor has the same variable attribute,
as formatted in `start_datetime` or `Sex`)

``` main
 # Sex 
  Sex = "M",
  
  # Genotypes
  Genotype = rep(c("SIP-L2-2", "SIP-L2-2",
                   "SIP-S2-8", "SIP-S2-8",
                   "SIP-S2-1", "SIP-S2-1",
                   "CS", "CS",
                   "SIP-S2-10", "SIP-S2-10",
                   "SIP-L2-1", "SIP-L2-1"), each = 32),
```

### 1.5 Experimental Factors: Experimental Treatments

Specify any experimental treatments for each population such as social
isolation, change in diet, sexual deprivation, etc..

``` main
# Temperature during monitoring
Temperature = "21.5C",

# Treatment applied during monitoring period
Treatment = rep(c("Iso_2D", "Grp_2D",
                    "Iso_2D", "Grp_2D",
                    "Iso_2D", "Grp_2D",
                    "Iso_2D", "Grp_2D",
                    "Iso_2D", "Grp_2D",
                    "Iso_2D", "Grp_2D"), each = 32),

# Environmental factors
  environment = "NA",
  
# Light.Dark phases
  light = "12.12"
)
```

### 1.6 Manually Excluding `notOK` flies.

Within certain cuvettes, you may see factors that would interfere
with your experimental results (mold growth, the incorrect sex, etc.).
To remove this fly from the analysis, change the following code to set the
`file` equal to `monitorXX.txt` to indicate which monitor the compromised fly was in. Set the `regionID` equal to the arena number the fly inhabited within that
monitor. Finally, remove the `#`
from before `info`. Repeat this process as necessary, adding a new line
of code each time.

``` main
# Change status manually to exclude cuvettes from analysis,
# info <- SetStatus(info, regionID=4, file="monitor33.txt")
```

## 2. Running the Package: Creating a HitRun.r File

Create a new R script in the parent directory named “HitRun.R”. In this
file, enter all of the following script excepting the optional sections
you do not want.

### 2.1 Set the Environment

Ensure the Library is loaded and set the working directory by running this code.
``` main
# Attach gigem to the path
library(gigem)

# Set working directory to the folder this HitRun.R file is within (which should be the parent directory)
parent_dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(parent_dir)
```

### 2.2 Run All or One Experimental Batch(es)

These are the main functions of gigem. 

For analyzing a single batch:
``` main
# Run the Analysis
runOneBatch(oneBatch = "Batch9_2Days", numDays = 2, 
              overlayVar = "Treatment", rowVar = "Sex", columnVar = "Genotype", 
              plotSelection = "All", font = "bold", pValues = TRUE)
```

For analyzing multiple batches simultaneously:
``` main
# Run the Analysis
runAllBatches(numDays = 2, 
              overlayVar = "Treatment", rowVar = "Sex", columnVar = "Genotype", 
              plotSelection = "All", font = "bold", pValues = TRUE)
```

#### 2.2.1 Set oneBatch (if running runOneBatch)

Set `oneBatch` to the same name as the sub-directory folder containing the experiment of interest
``` main
oneBatch = "Batch9_2Days"
```

#### 2.2.2 Define Length of Analysis

Decide the number of days you wish to analyze from the experiment. This
should be equal to or less than the number of days between `start_datetime` and
`stop_datetime`.
``` main
numDays = 2
```

#### 2.2.3 Select Plot Outputs

Decide if you want `All`, `None`, or `Select` plots generated within each batch.
``` main
plotSelection = "All"
```

#### 2.2.4 Partition Output Plots

Determine which experimental factors to partition the plots by. (See section 3 for reference)

Conditions within `Treatment` will each have a different color and will be superimposed in "overlay" plots

``` main
overlayVar = "Treatment"
```

`M(ales)` and `F(emales)` will be separated to show Males in the bottom row of the plots and Females in the top row.

``` main
rowVar = "Sex"
```

Different `Genotypes` will be placed side-by-side in different columns.

``` main
columnVar = "Genotype",
```

#### 2.2.5 Set Font

The default is `"plain"`, but options include `"plain"`, `"bold"`, `"italic"`, and `"bold.italic"`.

``` main
font = "bold",
```

#### 2.2.6 Set pValues

Setting `pValues` to `TRUE` causes the plot *combinedPlots* to display *t*-test values. (This only applies when exactly 2 conditions exist within the `overlayVar` experimental factor.)

``` main
pValues = TRUE,
```

## 3 Run Multi-Batch Analysis Plots (optional)

If you run runAllBatches, you can generate further plots to analyze the relationship between conditions within your experimental factors and sleep parameters across the batches.

### 3.1 Plot rankedDisplay

This function produces a bar graph with raw sleep values (min), change in sleep (`condition1` - `condition2`, min), or percentage of sleep change ([`condition1` - `condition2`] / `condition2`, %). 

`x` is set to an experimental factor, and (optionally) a `control` condition from within the selected experimental factor may be designated. 

`condition1` may be set to a condition within one of the non-`x` experimental factors. `condition2` should then be set to a control condition within the same non-`x` experimental factor. 

If the conditions are set, the `method` should be set to "Diff" for change in sleep or "Perc.Change" for percentage of sleep change. "Diff" is the default value when the conditions are set.

The plot data can be narrowed to include only particular conditions within the experimental factors by setting `treat`, `temp`, `enviro`, `sex`, `lights`, and/or `geno` to the desired condition(s). In this case, we produced two plots, one for the `Environment` "2D" and one for "5D".

``` main
# Plot normalized sleep loss for the variable desired (optional)
rankedDisplayOrder <- rankedDisplay(x = "Genotype", control = "CS", condition1 = "Iso", condition2 = "Grp",
              enviro = "2D")
rankedDisplay(x = "Genotype", control = "CS", condition1 = "Iso", condition2 = "Grp",
              enviro = "5D", ranking = rankedDisplayOrder)
```

The output will produce a PDF as well as list the order of `x` condition in the *x*-axis after the x is arranged by accending values. This output can be inputted into the variable `ranking` to impose the same x arrangement onto another produced rankedDisplay plot.

The variable `fitted` and `formula` refer to fitting the data to a linear model with the `formula` equal to an equation composed of Experimental factors and/or Batch (ex. "Genotype * Treatment + Batch").

`font` may be set to `"plain"`, `"bold"`, `"italic"`, and `"bold.italic"` with "plain" as the default.


### 3.2 Plot a Correlation Matrix (optional)

Select two `treatment` groups to compare in any order.

``` main
# Plot correlation matrix (optional)
corMat(Compare1 = "Grp_2D", Compare2 = "Iso_2D")
corMat(Compare1 = "Grp_5D", Compare2 = "Iso_5D")
```

### 3.3 Plot a Scatterplot Matrix with kmeans clustering & *a priori* groupings (optional)

A more thorough visualization of the Correlation Matrix may be seen in this scatterplot matrix. The arrangement of many scatterplots `aPrioriConditions` with the variable that common denominator is in in
`aPrioriFactor` (number of `aPrioriConditions` is restricted to one or more
entries). For example, the variable `aPrioriConditions` has many entries, but I
suspect the ones with “L1” in their names are similar to each other.
Likewise with “L2”, “S1”, “S2” and “CS”. Any entries in the designated
`aPrioriFactor` variable that do not match the specified `aPrioriConditions` will be
grouped together into an “NA” grouping.

The plot will show the actual similarity of monitors while indicating
the `aPrioriConditions` hypothesized.

Repeat with different variables as necessary. In this case, we produced scatter plots for 2 Days and 5 Days

``` main
# Plot scatterplots for 2 days and 5 days (optional)
corScatter(condition1 = "Iso", condition2 = "Grp", enviro = "2D",
              aPrioriConditions = c("L1", "L2", "S1", "S2", "CS"),
              aPrioriFactor = "Genotype", font = "bold")
              
corScatter(condition1 = "Iso", condition2 = "Grp", enviro = "5D",
              aPrioriConditions = c("L1", "L2", "S1", "S2", "CS"),
              aPrioriFactor = "Genotype", font = "bold")
```

## 4. Plots generated via plotSelection (see 2.2.3)

### 4.1 Sleep/Activity Profile

Should you set "`plotSelection` = `Select`", 6 or 7 prompts will appear sequentially in the console.
The user must type and enter ‘1’ or ‘2’ into the console to generate or not generate the particular plots. Below are
example plots for each of the questions.


Do you want to generate each monitor's 'Activity and Sleep Actograms'?

1: Yes 2: No

![Sleep Profile](images/sleepProfile.jpg) ![Sleep
Profile](images/sleepProfile.pdf) ![Activity
Profile](images/activityProfile.jpg) ![Activity
Profile](images/activityProfile.pdf)

### 4.1 Population Plots (full-length and 24-hour summary)

Do you want to generate 'Population Sleep Profiles'? (i.e. Each unique condition)

1: Yes 2: No

![Population Sleep Plots](images/popSleep.jpg) ![Population Sleep
Plots](images/popSleep.pdf) ![Summary Sleep Plots](images/popSleep2.jpg)
![Summary Sleep Plots](images/popSleep2.pdf)

### 4.3 Population Overlay (full-length and 24-hour summary)

Do you want to generate 'Overlaid Sleep Profiles'? (i.e. Each condition overlaid according to your first entry in 'Divisions')

1: Yes 2: No

![Population Overlay Plots](images/popOverlay.jpg) ![Population Overlay
Plots](images/popOverlay.pdf) ![Summary Overlay
Plots](images/popOverlay2.jpg) ![Summary Overlay
Plots](images/popOverlay2.pdf)

### 4.4 Batch-Grouped Sleep Bouts

Do you want to generate 'Overlaid Sleep Bout Profiles'?

1: Yes 2: No

![Sleep Bout Plots](images/sleepBouts.jpg) ![Sleep Bout
Plots](images/sleepBouts.pdf)

### 4.5 Batch-Grouped Quantitative Point Plots

Do you want to generate 'Quantifications of Sleep Traits'?

1: Yes 2: No

![Total minutes of sleep](images/pointPlots.jpg) ![Total minutes of
sleep](images/pointPlots.pdf) ![Number of bouts](images/pointPlots2.jpg)
![Number of bouts](images/pointPlots2.pdf)

### 4.6 Combined Plots for 'Overlaid Sleep Profiles (24Hr)' beside 'Quantifications' (Within Batches)

Do you want to generate 'Combined Plots (Within Batches)'?(i.e. All plots grouped by unique combination of variable conditions)

1: Yes 2: No

![Combined Plots Within Batches](images/CombinedPlots(oneBatch).jpg) ![Combined Plots Within Batches](images/CombinedPlots(oneBatch).pdf)

### 4.7 Combined Plots for 'Overlaid Sleep Profiles (24Hr)' beside 'Quantifications' (Across Batches)
*Note: This prompt will only appear if you are running 'runAllBatches.'*

Do you want to generate 'Combined Plots (Across Batches)'? (i.e. All plots grouped by unique combination of variable conditions)

1: Yes 2: No

![Combined Plots Across Batches](images/CombinedPlots(MultiBatch).jpg) ![Combined Plots Across Batches](images/CombinedPlots(MultiBatch).pdf)


## 5. Templates

### 5.1 “Main.R” template

``` main
# Set a title for the data analysis
Title = "Batch9_2Days"

# ----------------------------------------------------------------------------
# Create a data table 'info' to store details of the monitoring setup

info <- data.table::data.table(
  
  # Filename associated with each monitor's data
  # "each" reflects the number of sensors per monitor in the array used;
  # In this case, there are 32 sensors per DAM monitor, each holding data for 32 flies
  file = rep(c("Monitor22.txt", "Monitor7.txt",
               "Monitor14.txt", "Monitor3.txt",
               "Monitor15.txt", "Monitor39.txt",
               "Monitor53.txt", "Monitor27.txt",
               "Monitor52.txt", "Monitor17.txt",
               "Monitor21.txt", "Monitor50.txt"), each = 32),
  
  # Monitor identifier (this is a shorthand for each monitor in the experiment)
  monitor = rep(c("M22", "M7",
                  "M14", "M3",
                  "M15", "M39",
                  "M53", "M27",
                  "M52", "M17",
                  "M21", "M50"), each = 32),
  
  # Unique identifier for each sensor region (range from 1 to 32)
  region_id = 1:32,
  
  # Data status (e.g., whether the data collection was successful, marked "OK")
  status = "OK",
  
  # Start date and time of the monitoring period
  start_datetime = "2019-08-17 10:00:00",
  
  # Stop date and time of the monitoring period
  stop_datetime = "2019-08-19 10:05:00",
  
  # Sex of the subjects being monitored (M = Male, F = Female)
  sex = "M",
  
  # Genotype of the subjects being monitored (this is replicated for each group of flies)
  genotype = rep(c("SIP-L2-2", "SIP-L2-2",
                   "SIP-S2-8", "SIP-S2-8",
                   "SIP-S2-1", "SIP-S2-1",
                   "CS", "CS",
                   "SIP-S2-10", "SIP-S2-10",
                   "SIP-L2-1", "SIP-L2-1"), each = 32),
  
  # Temperature during the monitoring period
  temp = "21.5C",
  
  # Treatment applied during the monitoring period (e.g., Isolation or Group treatment)
  treatment = rep(c("Iso_2D", "Grp_2D",
                    "Iso_2D", "Grp_2D",
                    "Iso_2D", "Grp_2D",
                    "Iso_2D", "Grp_2D",
                    "Iso_2D", "Grp_2D",
                    "Iso_2D", "Grp_2D"), each = 32),
  
  # Environment condition during the experiment (e.g., NA if not applicable)
  environment = rep(c("NA", "NA",
                      "NA", "NA",
                      "NA", "NA",
                      "NA", "NA",
                      "NA", "NA",
                      "NA", "NA"), each = 32),
  
  # Light cycle during monitoring (e.g., light-dark cycle in hours)
  light = rep(c("12.12", "12.12",
                "12.12", "12.12",
                "12.12", "12.12",
                "12.12", "12.12",
                "12.12", "12.12",
                "12.12", "12.12"), each = 32)
)
# ----------------------------------------------------------------------------

# Change status manually to exclude cuvettes from analysis,
# info <- SetStatus(info, regionID=4, monitor="M33")
```

### 5.2 “HitRun.R” template

``` main
library(gigem)

parent_dir <- dirname(rstudioapi::getSourceEditorContext()$path)
setwd(parent_dir)

# Determine which variables to divide the plots by:
  # (e.g. temp, sex, genotype, treatment, environment, or light)
divisions<- c("treatment",            # 1: Sleep plot, overlay and color
              "sex",                  # 2: Sleep plot, rows
              "genotype",             # 3: Sleep plot, columns
              "treatment",            # 4: Point plot, x-axis and color
              "sex",                  # 3: Point plot, rows
              "genotype")             # 6: Point plot, columns

# Set the number of days you wish to analyze
num_days = 2

# Run the Analysis
runAllBatches(controlgeno = "CS", controltreat = "Grp")


# Optional functions -----------------------------------------------------------

# Plot correlation matrix (optional)
corMat(Compare1 = "Grp_2D", Compare2 = "Iso_2D")
corMat(Compare1 = "Grp_5D", Compare2 = "Iso_5D")


# Plot cluster groups for 2 days and 5 days (optional)
kmeansCluster(Compare1 = "Grp_5D", Compare2 = "Iso_5D", 
              groupings = c("L1", "L2", "S1", "S2", "CS"), column_name = "genotype")
kmeansCluster(Compare1 = "Grp_2D", Compare2 = "Iso_2D", 
              groupings = c("L1", "L2", "S1", "S2", "CS"), column_name = "genotype")

# Plot normalized sleep loss for the variable desired (optional)
normDisplay(treat = "Iso_5D", treat2 = "Iso_2D", column_name = "genotype", Control = "CS")
```
